---
#    self_contained: yes
output:
  github_document:
    html_preview: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  collapse = TRUE,
  comment = "#>",
  fig.width = 13,
  fig.height = 9 
)

set.seed(42)
```

```{r}
library(ggplot2)
library(readr)
library(dplyr)
library(tidyr)

library(slendr)
init_env(quiet = TRUE)
```

```{r}
anc <- population("ancestor", N = 10000, time = 1000000, remove = 649000)
afr <- population("AFR", parent = anc, N = 10000, time = 650000)
nea <- population("NEA", parent = anc, N = 2000, time = 650000)
eur <- population("EUR", parent = afr, N = 5000, time = 80000)

gen_time <- 27
t_admix <- round(55000 / gen_time) * gen_time

gf <- gene_flow(from = nea, to = eur, rate = 0.03, start = t_admix, end = t_admix - gen_time)

model <- compile_model(
  populations = list(anc, afr, nea, eur), gene_flow = gf,
  generation_time = gen_time
)

samples <- schedule_sampling(model, times = c(50, 40, 30, 20, 10, 0) * 1e3, list(eur, 10))

plot_model(model, proportions = TRUE, order = c("AFR", "EUR", "ancestor", "NEA"))
```

```{r, eval=!file.exists("data/sim_tracts.tsv")}
ts <- msprime(model, sequence_length = 100e6, recombination_rate = 1e-8, samples = samples, random_seed = 42)

tracts_df <- ts_tracts(ts, census = t_admix, quiet = TRUE) %>%
  dplyr::select(-node_id, -pop, -source_pop, -source_pop_id)

samples_df <- ts_samples(ts)

tracts_df <- inner_join(samples_df, tracts_df, by = "name")

write.table(tracts_df, file = "data/sim_tracts.tsv",
            sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)
```

```{r, eval=file.exists("data/sim_tracts.tsv")}
tracts_df <- read_tsv("data/sim_tracts.tsv")
```

## Estimating admixture time from tract lengths

```{r}
# sample_age <- 50000
# min_length <- 25e3

pdf("dating.pdf", width = 14, height = 8)

results <- list(time = c(), min_length = c(), lambda_lm = c(), lambda_mean = c())

max_length <- 1e6
for (min_length in c(0, 25e3, 50e3)) {
for (sample_age in unique(samples$time) ) {
  
# cat("minimum length:", min_length, "\nsample_age:", sample_age, "\n")

r <- 1e-8

filtered_tracts <- tracts_df %>% filter(time == sample_age, length >= min_length, length <= max_length)

bin_data <- hist(filtered_tracts$length, plot = FALSE, breaks = 100)
density <- bin_data$density
length <- bin_data$mids[density > 0]
density <- density[density > 0]

# lm estimate
lm_res <- lm(log(density) ~ length, weights = 1 / length)
lambda_lm <- -coef(lm_res)[["length"]]
if (lambda_lm < 0) lambda_lm <- NA

t_gens_lm <- lambda_lm / r
t_lm <- t_gens_lm * gen_time + sample_age

# MLE estimate
L <- mean(filtered_tracts$length)
lambda_mean <- 1 / (L - min_length)

t_gens_mean <- 1 / (r * 1 / lambda_mean)
t_mean <- t_gens_mean * gen_time + sample_age

# plotting
orig_par <- par(no.readonly = TRUE)

par(mfrow = c(1, 2))

title <- sprintf("sample age %d, tract length [%d bp, %d Mb]", sample_age, min_length, max_length / 1e6)

legends <-c(sprintf("lm fit of t = %.1f kya", round(t_lm / 1e3, 1)),
            sprintf("MLE fit of t = %.1f kya", round(t_mean / 1e3, 1)))

# plot the results on the original exponential scale
y_lm <- dexp(length, rate = lambda_lm)
y_mean <- dexp(length, rate = lambda_mean)

ylim <- c(min(c(density, y_lm, y_mean), na.rm = TRUE), max(c(density, y_lm, y_mean), na.rm = TRUE))
plot(length, density, xlim = c(0, max(length)), main = title, ylim = ylim)
lines(length + min_length, y_lm, col = "orange", lty = 2)
lines(length + min_length, y_mean, col = "blue", lty = 2)

legend("topright", fill = c("orange", "blue"), legend = legends)

# plot the results on the log-transformed scale
plot(length, log(density), xlim = c(0, max(length)), main = title)
abline(lm_res, col = "orange", lty = 2)
slope <- -lambda_mean
intercept <- log(lambda_mean)
abline(a = intercept, b = slope, col = "blue", lty = 2)

legend("topright", fill = c("orange", "blue"), legend = legends)

par(orig_par)

results[["time"]] <- c(results[["time"]], sample_age)
results[["min_length"]] <- c(results[["min_length"]], min_length)
results[["lambda_lm"]] <- c(results[["lambda_lm"]], lambda_lm)
results[["lambda_mean"]] <- c(results[["lambda_mean"]], lambda_mean)

}
}

dev.off()

results_df <- as_tibble(results)
```

### Full, unfiltered distribution of tract lengths

```{r}
tracts_full <- tracts_df
```

```{r}
p_tracts_full <-
  ggplot() +
  geom_histogram(data = tracts_full, aes(x = length, y = after_stat(density), fill = as.factor(time)),
                 binwidth = 10000, alpha = 0.75) +
  labs(
    x = "tract length [bp]", y = "density", fill = "age of sample",
    title = "Tract length distribution as a function of admixed sample's age",
    subtitle = "(assuming admixture time in a single pulse at ~ 55 kya)"
  ) +
  scale_x_continuous(labels = scales::comma) +
  coord_cartesian(ylim = c(0, 2e-5)) +
  theme_minimal() +
  theme(legend.position = "none", text = element_text(size = 15)) +
  facet_wrap(~ time, labeller = labeller(time = function(x) paste("sample age =", x, "kya")))

p_tracts_full
```

```{r}
r <- 1e-8

exp_full_df <- group_by(tracts_full, time) %>%
  summarise(L = mean(length)) %>%
  mutate(
    lambda = 1 / L,
    t_gen = 1 / (r / lambda),
    t_before = t_gen * gen_time,
    t_admix = t_before + time
  )

exp_full_df
```

```{r}
exp_full_decay <- function(lambda, max_length) {
  data.frame(length = seq(0, max_length, by = 100000)) %>%
    mutate(density = dexp(length, rate = lambda))
}

predictions_full_df <-
  exp_full_df %>%
  rowwise() %>%
  mutate(exp_data = list(exp_decay(lambda, max(tracts_full$length)))) %>%
  unnest(cols = c(exp_data))

p_fit_full <- p_tracts_full +
  geom_line(data = predictions_full_df, aes(x = length, y = density),
            linetype = "dashed", linewidth = 0.75, color = "black") +
  geom_text(data = exp_full_df,
            aes(x = Inf, y = Inf, label = paste("estimated admixture at", round(t_admix / 1e3, 1), "kya"),
                color = as.factor(time)),
            hjust = 1.2, vjust = 8, size = 4)

p_fit_full
```

## Distribution of truncated tract lengths

```{r}
cutoff <- 50e3

tracts_trunc <- tracts_df %>% filter(length > cutoff)
```

```{r}
p_tracts_trunc <-
  ggplot() +
  geom_histogram(data = tracts_trunc, aes(x = length, y = after_stat(density), fill = as.factor(time)),
                 binwidth = 10000, alpha = 0.75) +
  labs(
    x = "tract length [bp]", y = "density", fill = "age of sample",
    title = "Tract length distribution as a function of admixed sample's age",
    subtitle = "(assuming admixture time in a single pulse at ~ 55 kya)"
  ) +
  scale_x_continuous(labels = scales::comma) +
  coord_cartesian(ylim = c(0, 2e-5)) +
  theme_minimal() +
  theme(legend.position = "none", text = element_text(size = 15)) +
  facet_wrap(~ time, labeller = labeller(time = function(x) paste("sample age =", x, "kya")))

p_tracts_trunc
```

```{r}
r <- 1e-8

exp_trunc_df <- group_by(tracts_trunc, time) %>%
  summarise(L = mean(length)) %>%
  mutate(
    lambda = 1 / (L - cutoff),
    t_gen = 1 / (r / lambda),
    t_before = t_gen * gen_time,
    t_admix = t_before + time
  )

exp_trunc_df
```

```{r}
exp_trunc_decay <- function(lambda, max_length) {
  data.frame(length = seq(0, max_length, by = 100000)) %>%
    mutate(density = dexp(length, rate = lambda))
}

predictions_trunc_df <-
  exp_full_df %>%
  rowwise() %>%
  mutate(exp_data = list(exp_decay(lambda, max(tracts_trunc$length)))) %>%
  unnest(cols = c(exp_data))

p_fit_trunc <- p_tracts_trunc +
  geom_line(data = predictions_trunc_df, aes(x = length + cutoff, y = density),
            linetype = "dashed", linewidth = 0.75, color = "black") +
  geom_text(data = exp_trunc_df,
            aes(x = Inf, y = Inf, label = paste("estimated admixture at", round(t_admix / 1e3, 1), "kya"),
                color = as.factor(time)),
            hjust = 1.2, vjust = 8, size = 4)

p_fit_trunc
```

## Comparison of both filterings

```{r}
ggplot() +
  geom_density(data = tracts_df,
               aes(length, y = after_stat(count), color = factor(time))) +
  geom_density(data = filter(tracts_df, length >= cutoff),
               aes(length, y = after_stat(count), color = factor(time)),
               linetype = "dashed", color = "black") +
  facet_wrap(~ time) +
  coord_cartesian(xlim = c(0, 1e6))
```

```{r}
p_fit_full
p_fit_trunc
```


<!-- ```{r} -->
<!-- bins <- sort(unique(tracts_df$bin)) -->
<!-- counts <- as.integer(table(tracts_df$bin)) -->

<!-- plot(bins, counts, xlab = "Neanderthal tract length bin", ylab = "count of tracts in bin") -->
<!-- ``` -->
