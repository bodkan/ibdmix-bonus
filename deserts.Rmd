---
#    self_contained: yes
output:
  github_document:
    html_preview: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  collapse = TRUE,
  comment = "#>",
  fig.width = 13,
  fig.height = 9 
)

set.seed(42)
```

```{r}
suppressPackageStartupMessages({
  library(readr)
  library(dplyr)
  library(tidyr)
  library(ggplot2)
  library(sf)
  library(rnaturalearth)

  library(GenomicRanges)
  library(ggbio)
  library(plyranges)
})

source(here::here("utils.R"))
```

```{r}
# IBDmix desert coordinates from Table S8 of Chan et al., 202
# (https://ars.els-cdn.com/content/image/1-s2.0-S0092867420300593-mmc1.pdf)
# (https://ars.els-cdn.com/content/image/1-s2.0-S0092867420300593-figs4_lrg.jpg)

deserts_df <- tribble(
  ~chrom, ~start_ss, ~end_ss,   ~start_ibdmix, ~end_ibdmix,
  "chr1", 102200000, 114900000, 105400000,     120600000,
  "chr3", 76500000,  90500000,  74100000,      89300000,
  "chr7", 106300000, 124700000, 106200000,     123200000,
  "chr8", 53900000,  66000000,  49400000,      66500000
) %>% pivot_longer(cols = c(starts_with("start_"), starts_with("end_")),
                   names_to = c(".value", "method"), names_sep = "_")

# convert S* and IBDmix coordinates above into GRanges objects
ss_deserts_gr <- filter(deserts_df, method == "ss") %>% makeGRangesFromDataFrame()
ibdmix_deserts_gr <- filter(deserts_df, method == "ibdmix") %>% makeGRangesFromDataFrame()

# get intersect of Neanderthal-only deserts inferred by both methods
deserts_gr <- pintersect(ss_deserts_gr, ibdmix_deserts_gr)
```

```{r}
# combined Neanderthal and Denisovan deserts -- Table S9 on page 51 of
# https://www.science.org/doi/suppl/10.1126/science.aad9416/suppl_file/vernot-sm.pdf
ss2_deserts_gr <- tribble(
  ~chrom, ~start, ~end,
  "chr1", 104000000, 114900000,
  "chr3", 76500000, 90500000,
  "chr7", 113600000, 124700000,
  "chr8", 54500000, 65400000
) %>% makeGRangesFromDataFrame()

# get intersect of S* Neanderthal AND Denisovan deserts and IBDmix Neanderthal deserts
deserts2_gr <- pintersect(ss2_deserts_gr, ibdmix_deserts_gr)
```

```{r}
ss_deserts_gr$width <- width(ss_deserts_gr) / 1e6
ibdmix_deserts_gr$width <- width(ibdmix_deserts_gr) / 1e6
deserts_gr$width <- width(deserts_gr) / 1e6

ss2_deserts_gr$width <- width(ss2_deserts_gr) / 1e6
deserts2_gr$width <- width(deserts2_gr) / 1e6
```

```{r}
ss_deserts_gr
ibdmix_deserts_gr
deserts_gr

ss2_deserts_gr
deserts2_gr
```

In the visualizations below, we will define archaic deserts as the intersection of Neanderthal deserts obtained from S* and Neanderthal deserts obtained by IBDmix:

```{r}
# deserts_gr <- deserts2_gr

desert_coords <- deserts_gr %>% as.data.frame() %>% select(chrom = seqnames, start, end)
desert_coords
```

## Load and inspect GeoGenetics metadata

```{r}
metadata <- read_metadata()
```

```{r}
glimpse(metadata)
```

Plot the spatial distribution of all ancient samples in the imputed data:

```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")
sf::st_agr(world) <- "constant"
bbox <- st_as_sfc(st_bbox(c(xmin = -25, xmax = 65, ymin = 25, ymax = 70), crs = st_crs(world)))
western_eurasia <- st_crop(st_make_valid(world), bbox)

metadata %>%
  filter(!is.na(latitude) & !is.na(longitude)) %>%
  st_as_sf(coords = c("longitude", "latitude")) %>%
  st_set_crs(4326) %>%
  ggplot() +
    geom_sf(data = western_eurasia) +
    geom_sf(aes(color = region)) +
    coord_sf(crs = 3035)
```

Out of the various "age" columns in the GeoGenetics metadata, which one is actually usable?

```{r}
filter(metadata, groupAge == "Ancient") %>%
  summarise_at(c("age14C", "ageAverage", "ageRaw"),
               list(total = ~length(.), missing = ~sum(is.na(.x)), prop = ~mean(is.na(.x)))) %>%
  pivot_longer(cols = everything(), names_to = "name") %>%
  separate(name, into = c("measure", "type"), sep = "_", extra = "merge")
```

Looks like `ageAverage` has a value for every individual:

```{r}
metadata %>%
  filter(groupAge == "Ancient") %>%
  ggplot() +
  geom_histogram(aes(ageAverage))
```

## Inspect Neanderthal tracts in ancient and present-day individuals

```{r}
tracts_modern <- read_tracts("Modern", metadata)
tracts_ancient <- read_tracts("Ancient", metadata)

tracts <- rbind(tracts_modern, tracts_ancient)

tracts
```

```{r}
tracts %>%
filter(chrom %in% as.character(seqnames(deserts_gr))) %>%
ggplot(aes(x = start, xend = end, y = ID, yend = ID)) +
  geom_segment(linewidth = 1) +
  geom_rect(data = desert_coords, aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf), inherit.aes = FALSE, fill = "red", alpha = 0.1) +
  geom_vline(data = desert_coords, aes(xintercept = start), linetype = "dashed", color = "red") +
  geom_vline(data = desert_coords, aes(xintercept = end), linetype = "dashed", color = "red") +
  labs(x = "position along a chromosome [bp]", y = "each row = tracts in an individual") +
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_blank(),
    panel.grid = element_blank()
  ) +
  scale_x_continuous(labels = scales::comma) +
  facet_grid(set ~ chrom, scales = "free") +
  ggtitle("Neanderthal tracts in Eurasians")
```

```{r}
ggplot2::ggsave(paste0("deserts_1+3+7+8.pdf"), width = 13, height = 7)
```

## Analysis of tracts inferred in real data

Convert the IBDmix tracts data frame to `GRanges`:

```{r}
library(BSgenome.Hsapiens.UCSC.hg19)

tracts_gr <- tracts %>% makeGRangesFromDataFrame(keep.extra.columns = TRUE)

seqlengths(tracts_gr) <- seqlengths(BSgenome.Hsapiens.UCSC.hg19)[names(seqlengths(tracts_gr))]
genome(tracts_gr) <- "hg19"

tracts_gr
```

### Fetch gaps from USCS

```{r}
library(ggbio)
library(rtracklayer)
library(plyranges)

mySession <- browserSession()
genome(mySession) <- "hg19"
query <- ucscTableQuery(mySession, table = "gap")

# gap table columns: https://genome.ucsc.edu/cgi-bin/hgTables?db=hg38&hgta_group=map&hgta_track=gap&hgta_table=gap&hgta_doSchema=describe+table+schema
gaps <- getTable(query) %>%
  dplyr::filter(grepl("chr\\d+$", chrom)) %>% as_tibble()

gaps_gr <- makeGRangesFromDataFrame(gaps, starts.in.df.are.0based = TRUE, keep.extra.columns = TRUE, ignore.strand = TRUE)
seqinfo(gaps_gr) <- seqinfo(tracts_gr)

gaps_gr
```

```{r}
gaps_gr %>%
  filter(seqnames %in% seqnames(deserts_gr)) %>%
  autoplot(aes(fill = type), color = NA) +
  theme_bw() +
  theme(panel.grid = element_blank(), legend.position = "bottom")
```

### Analyse tracts in windows

```{r}
windows_gr <- generate_windows(gaps_gr, window_size = 100e3, step_size = 50e3)
# windows_gr <- filter(windows_gr, seqnames == "chr7")

# mark windows falling within archaic deserts
windows_gr$within_desert <- FALSE
windows_gr[queryHits(findOverlaps(windows_gr, deserts_gr))]$within_desert <- TRUE

ancestry_modern_gr <- filter(tracts_gr, set == "Modern") %>% compute_ancestry(windows_gr)
ancestry_ancient_gr <- filter(tracts_gr, set == "Ancient") %>% compute_ancestry(windows_gr)

ancestry_gr <- windows_gr
ancestry_gr$modern <- ancestry_modern_gr$coverage
ancestry_gr$ancient <- ancestry_ancient_gr$coverage

ancestry_gr
```

Average Neanderthal ancestry proportion across all windows in ancient and present-day individuals:

```{r}
ancestry_gr %>%
  as_tibble() %>%
  summarise(
    neand_ancient = mean(ancient, na.rm = TRUE),
    neand_modern = mean(modern, na.rm = TRUE)
  )
```

Average Neanderthal ancestry proportion across all windows in ancient and present-day individuals **within desert regions**:

```{r}
filter(ancestry_gr, within_desert) %>%
  as_tibble() %>%
  group_by(seqnames) %>%
  summarise(
    desert_ancient = mean(ancient, na.rm = TRUE),
    desert_modern = mean(modern, na.rm = TRUE)
  )
```

```{r}
ancestry_gr %>%
  as_tibble() %>%
  filter(within_desert) %>%
  dplyr::rename(chrom = seqnames) %>%
  mutate(chrom = as.character(chrom)) %>%
  group_by(chrom) %>% 
  summarise(
    mean(ancient == 0 & modern > 0),
    mean(ancient > 0 & modern == 0),
    mean((ancient == 0 & modern == 0) | (ancient > 0 & modern > 0))
  ) %>%
  pivot_longer(cols = contains("mean"), values_to = "proportion of sites") %>%
  split(.$chrom)
```

```{r}
pdf("deserts_comparison.pdf", width = 12, height = 8)

for (chrom in as.character(unique(seqnames(deserts_gr)))) {
  p1 <- plot_desert_ancestry(ancestry_gr, deserts_gr, chrom)
  p2 <- plot_desert_correlation(ancestry_gr, chrom)
  
  suppressWarnings(print(cowplot::plot_grid(p1, p2, nrow = 1, rel_widths = c(1, 1))))
}

dev.off()
```

```{r, fig.width=12, fig.height=8}
p1 <- plot_desert_ancestry(ancestry_gr, deserts_gr, "chr7")
p2 <- plot_desert_correlation(ancestry_gr, "chr7")

cowplot::plot_grid(p1, p2, nrow = 1, rel_widths = c(1, 1))
```

## A couple of diagnostics and sanity checks

### Comparison of tracts between ancient and present-day humans

```{r}
tracts_df <- select(metadata, sampleId, ageAverage) %>% inner_join(tracts, by = c("sampleId" = "ID"))
tracts_df$length <- tracts_df$end - tracts_df$start
tracts_df$ageAverage <- ifelse(is.na(tracts_df$ageAverage), 0, tracts_df$ageAverage)

tracts_df$age_group <- cut(
  tracts_df$ageAverage,
  breaks = c(Inf, 20e3, 10e3, 5e3, 100, 0),
)

group_levels <- levels(tracts_df$age_group)

tracts_df <- tracts_df %>%
  mutate(
    age_group = as.character(age_group),
    age_group = ifelse(is.na(age_group), "present-day", age_group),
    age_group = factor(age_group, levels = c("present-day", group_levels))
  )
```

### Sanity checks of my filtering against Alba's Figure 2. B/C

```{r}
group_by(tracts_df, age_group) %>%
  summarise(mean(length), min(length), max(length))
```

```{r}
ggplot(tracts_df) +
  geom_density(aes(length, color = age_group)) +
  scale_x_log10()
```

```{r}
ggplot(tracts_df) +
  geom_boxplot(aes(age_group, length, color = age_group)) +
  geom_hline(yintercept = c(50e3, 250e3), linetype = "dashed")
```

```{r}
ggplot(tracts_df) +
  geom_boxplot(aes(age_group, length, color = age_group)) +
  geom_hline(yintercept = c(50e3, 250e3), linetype = "dashed") +
  coord_cartesian(ylim = c(50e3, 250e3)) 
```

## Fitting exponential decay to simulated tracts

### Complete (unfiltered) tract distribution

```{r}
sim_tracts <- read.table(url("https://github.com/bodkan/ku-introgression2024/raw/main/tracts.tsv"), sep = "\t", header = TRUE)

average_bins <- aggregate(length ~ bin, data = sim_tracts, FUN = mean)
(bin_step <- mean(diff(average_bins$length)))

# get the bin numbers
bins <- sort(unique(sim_tracts$bin))

# count the tracts in each bin and compute the proportion of tracts in each bin
counts <- as.integer(table(sim_tracts$bin))
props <- counts / sum(counts)

plot(bins, counts, xlab = "Neanderthal tract length bin", ylab = "proportion of tracts", xlim = c(1, 50), ylim = c(0, 1000))
```

```{r}
r <- 1e-8

fit_fitdistr <- MASS::fitdistr(sim_tracts$length, "exponential")

plot(bins, counts, xlab = "Neanderthal tract length bin", ylab = "proportion of tracts", xlim = c(1, 50), ylim = c(0, 1000))

lambda_fitdistr <- fit_fitdistr$estimate["rate"]
y_fitdistr <- dexp(bins, rate = lambda_fitdistr * bin_step)
lines(bins, y_fitdistr * sum(counts), col = "red", lty = 2)

t <- 1 / (r * 1 / lambda_fitdistr)
cat("Result from fitdistr: ", t, "\n")

lambda_mean <- 1 / mean(sim_tracts$length)
y_mean <- dexp(bins, rate = lambda_mean * bin_step)
lines(bins, y_mean * sum(counts), col = "green", lty = 2)

t <- 1 / (r * 1 / lambda_mean)
cat("Result from simple equation: ", t, "\n")
```

```{r}
r <- 1e-8

plot(bins, counts, xlab = "Neanderthal tract length bin", ylab = "proportion of tracts", xlim = c(1, 50), ylim = c(0, 1000))

fit_nls <- nls(counts ~ SSasymp(bins, Asym, R0, lrc))
summary(fit_nls)

# https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/SSasymp
lambda_nls <- exp(coef(fit_nls)["lrc"])
y_nls <- dexp(bins, rate = lambda_nls)
lines(bins, y_nls * sum(counts), col = "red")

t <- 1 / (bin_step * r * 1 / lambda_nls)
cat("Result from nls: ", t, "\n")

lines(bins, y_mean * sum(counts), col = "green", lty = 2)

t <- 1 / (r * 1 / lambda_mean)
cat("Result from simple equation: ", t, "\n")
```


### Filtered tracts (truncating the shortest tracts)

```{r}
n_truncated <- 1

truncated_sim_tracts <- sim_tracts %>% filter(bin > n_truncated)

bins <- sort(unique(sim_tracts$bin))

counts <- c(rep(NA, n_truncated), as.integer(table(truncated_sim_tracts$bin)))
props <- counts / sum(counts)

plot(bins, counts, xlab = "Neanderthal tract length bin", ylab = "proportion of tracts", xlim = c(1, 50), ylim = c(0, 1000))
```

```{r}
r <- 1e-8

fit_trunc_fitdistr <- MASS::fitdistr(truncated_sim_tracts$length, "exponential")

plot(bins, counts, xlab = "Neanderthal tract length bin", ylab = "proportion of tracts", xlim = c(1, 50), ylim = c(0, 1000))

lambda_trunc_fitdirstr <- fit_trunc_fitdistr$estimate["rate"]
y_trunc_fitdistr <- dexp(bins, rate = lambda_trunc_fitdirstr * bin_step)
lines(bins, y_trunc_fitdistr * sum(counts, na.rm = TRUE), col = "orange", lty = 2)

t <- 1 / (r * 1 / lambda_trunc_fitdirstr)
cat("Result from fitdistr: ", t, "\n")
```

```{r}
r <- 1e-8

plot(bins, counts, xlab = "Neanderthal tract length bin", ylab = "proportion of tracts", xlim = c(1, 50), ylim = c(0, 1000))

fit_trunc_nls <- nls(counts ~ SSasymp(bins, Asym, R0, lrc))
summary(fit_trunc_nls)
lines(bins[-(1:n_truncated)], predict(fit_trunc_nls), col = "blue")

fit_trunc_nls2 <- nls(counts ~ SSasymp(bins, Asym, R0, lrc), weights = sqrt(1 / bins))
summary(fit_trunc_nls2)
lines(bins[-(1:n_truncated)], predict(fit_trunc_nls2), col = "green")

lines(bins, predict(fit_nls), col = "red")

# https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/SSasymp
# https://stats.stackexchange.com/questions/318971/fitting-exponential-decay-with-negative-y-values
lambda_trunc_nls <- exp(coef(fit_trunc_nls)["lrc"])
y_trunc_nls <- dexp(bins[-(1:n_truncated)], rate = lambda_trunc_nls)
lines(bins[-(1:n_truncated)], y_trunc_nls * sum(counts, na.rm = TRUE), col = "blue", lty = 2)

t <- 1 / (bin_step * r * 1 / lambda_trunc_nls)
cat("Result from nls: ", t, "\n")

lambda_trunc_nls2 <- exp(coef(fit_trunc_nls2)["lrc"])
y_trunc_nls2 <- dexp(bins[-(1:n_truncated)], rate = lambda_trunc_nls2)
lines(bins[-(1:n_truncated)], y_trunc_nls2 * sum(counts, na.rm = TRUE), col = "green", lty = 2)

t <- 1 / (bin_step * r * 1 / lambda_trunc_nls2)
cat("Result from nls: ", t, "\n")
```

```{r}
ssasymp_function <- function(x, Asym, R0, lrc) {
  Asym + (R0 - Asym) * exp(-exp(lrc) * x)
}

params <- coef(fit_trunc_nls2)
Asym <- params["Asym"]
R0 <- params["R0"]
lrc <- params["lrc"]

ssasymp_predictions <- ssasymp_function(bins, Asym, R0, lrc)

lambda <- exp(lrc)

# Generate exponential predictions
exponential_predictions <- dexp(bins, rate = lambda)

# Scale exponential predictions to match counts
scale_factor <- sum(counts, na.rm = TRUE) / sum(exponential_predictions)
scaled_exponential_predictions <- exponential_predictions * scale_factor

plot(bins, counts, main = "Model Comparison", xlab = "Bins", ylab = "Counts", pch = 19, ylim = c(0, 1000))
lines(bins, ssasymp_predictions, col = "blue", lwd = 2, type = "l", lty = 1)  # SSasymp predictions
lines(bins[!is.na(counts)], predict(fit_trunc_nls2), col = "green", ltye = 2)
lines(bins, scaled_exponential_predictions, col = "red", lwd = 2, type = "l", lty = 2)  # Exponential predictions

lines(bins, predict(fit_nls), col = "orange")
lines(bins, y_fitdistr * sum(counts), col = "orange")

legend("topright", legend = c("SSasymp Predictions", "Exponential Predictions", "non-truncated fit"),
       col = c("blue", "red", "orange"), lty = 1:2)

# custom ssasymp_function and predict() on a nls object are the same
ssasymp_predictions[-1] - predict(fit_trunc_nls2)
```


## Fitting exponential decay to empirical tracts

```{r}
bin_step <- 10e3

tract_bins <- tracts_df %>%
  filter(set == "Modern") %>%
  # mutate(bin = cut(width, breaks = tracts_sim$max, labels = FALSE, include.lowest = TRUE)) %>%
  mutate(bin = cut(length, breaks = seq(1, max(length) + bin_step, by = bin_step - 1), labels = FALSE, include.lowest = TRUE))

tract_bins %>%
  group_by(bin) %>%
  summarise(min(length), max(length), mean(length), n())
```

```{r}
bins <- sort(unique(tract_bins$bin))

counts <- as.integer(table(tract_bins$bin))
props <- counts / sum(counts)

plot(bins, counts, xlab = "Neanderthal tract length bin", ylab = "proportion of tracts", xlim = c(1, 50))
```

```{r}
fit <- MASS::fitdistr(tract_bins$length - min(tract_bins$length), "exponential")

plot(bins, counts, xlab = "Neanderthal tract length bin", ylab = "proportion of tracts", xlim = c(1, 50))

# lambda <- r * fit$estimate * bin_step
rate <- unname(fit$estimate["rate"])
y <- dexp(seq(1, max(bins)), rate = rate * bin_step)
lines(bins + 5, y[bins] * sum(counts), col = "red", lty = 2)

r <- 1e-8
lambda <- 1 / rate
t <- 1 / (r * lambda)
t
```




## Chen _et al._ tracts

```{r}
chen_tracts <- read_tsv("data/Chen et al. - Neanderthal sequence in 1000 genome.50kb.txt") %>%
  filter(anc == "EUR") %>%
  select(ID, chrom = chr, start, end) %>%
  mutate(chrom = paste0("chr", chrom), set = "Chen et al.")
```

```{r}
all_tracts <- bind_rows(tracts, chen_tracts)
```

```{r}
group_by(all_tracts, set) %>% tally()
```

### Comparison of Chen _at al._'s and Alba's results

```{r}
all_tracts %>%
filter(set != "Ancient", chrom %in% as.character(unique(seqnames(deserts_gr)))) %>%
ggplot(aes(x = start, xend = end, y = ID, yend = ID)) +
  geom_segment(linewidth = 1) +
  geom_rect(data = desert_coords, aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf), inherit.aes = FALSE, fill = "red", alpha = 0.1) +
  geom_vline(data = desert_coords, aes(xintercept = start), linetype = "dashed", color = "red") +
  geom_vline(data = desert_coords, aes(xintercept = end), linetype = "dashed", color = "red") +
  labs(x = "position along a chromosome [bp]", y = "each row = tracts in an individual") +
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_blank(),
    panel.grid = element_blank()
  ) +
  scale_x_continuous(labels = scales::comma) +
  facet_grid(set ~ chrom, scales = "free") +
  ggtitle("Neanderthal tracts in Eurasians")
```

### Deserts in the Chen _et al._ data

```{r}
chen_gr <- chen_tracts %>% makeGRangesFromDataFrame(keep.extra.columns = TRUE)

seqlengths(chen_gr) <- seqlengths(BSgenome.Hsapiens.UCSC.hg19)[names(seqlengths(chen_gr))]
genome(chen_gr) <- "hg19"

chen_gr
```

```{r}
ancestry_chen_gr <- chen_gr %>% compute_ancestry(windows_gr)

ancestry_gr$chen <- ancestry_chen_gr$coverage

ancestry_gr
```

```{r}
saveRDS(ancestry_gr, "ancestry_gr.rds")
```

```{r}
ancestry_gr <- readRDS("ancestry_gr.rds")
```

```{r, fig.width=12, fig.height=8}
plot_desert_ancestry2(ancestry_gr, deserts_gr, "chr1")
```

```{r, fig.width=12, fig.height=8}
plot_desert_ancestry2(ancestry_gr, deserts_gr, "chr3")
```

```{r, fig.width=12, fig.height=8}
plot_desert_ancestry2(ancestry_gr, deserts_gr, "chr7")
```

```{r, fig.width=12, fig.height=8}
plot_desert_ancestry2(ancestry_gr, deserts_gr, "chr8")
```
