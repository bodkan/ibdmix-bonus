---
#    self_contained: yes
output:
  github_document:
    html_preview: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  collapse = TRUE,
  comment = "#>",
  fig.path = "figures/",
  fig.width = 10,
  fig.height = 8
)

set.seed(42)

dir.create("results", showWarnings = FALSE)
```

```{r}
suppressPackageStartupMessages({
  library(readr)
  library(dplyr)
  library(tidyr)
  library(ggplot2)
  library(sf)
  library(rnaturalearth)

  library(GenomicRanges)
  library(ggbio)
  library(plyranges)
})

source(here::here("utils.R"))
```

```{r}
# IBDmix desert coordinates from Table S8 of Chan et al., 202 ---------------------------------
# (https://ars.els-cdn.com/content/image/1-s2.0-S0092867420300593-mmc1.pdf)
# (https://ars.els-cdn.com/content/image/1-s2.0-S0092867420300593-figs4_lrg.jpg)

deserts_df <- tribble(
  ~chrom, ~start_ss, ~end_ss,   ~start_ibdmix, ~end_ibdmix,
  "chr1", 102200000, 114900000, 105400000,     120600000,
  "chr3", 76500000,  90500000,  74100000,      89300000,
  "chr7", 106300000, 124700000, 106200000,     123200000,
  "chr8", 53900000,  66000000,  49400000,      66500000
) %>% pivot_longer(cols = c(starts_with("start_"), starts_with("end_")),
                   names_to = c(".value", "method"), names_sep = "_")
```

```{r}
# combined Neanderthal and Denisovan deserts
# (https://www.science.org/doi/suppl/10.1126/science.aad9416/suppl_file/vernot-sm.pdf)
ss2_deserts_gr <- tribble(
  ~chrom, ~start, ~end,
  "chr1", 104000000, 114900000,
  "chr3", 76500000, 90500000,
  "chr7", 113600000, 124700000,
  "chr8", 54500000, 65400000
) %>% makeGRangesFromDataFrame()
```

```{r}
ss_deserts_gr <- filter(deserts_df, method == "ss") %>% makeGRangesFromDataFrame()
ibdmix_deserts_gr <- filter(deserts_df, method == "ibdmix") %>% makeGRangesFromDataFrame()
deserts_gr <- pintersect(ss_deserts_gr, ibdmix_deserts_gr)
deserts2_gr <- pintersect(ss2_deserts_gr, ibdmix_deserts_gr)

ss_deserts_gr$width <- width(ss_deserts_gr) / 1e6
ss2_deserts_gr$width <- width(ss2_deserts_gr) / 1e6
ibdmix_deserts_gr$width <- width(ibdmix_deserts_gr) / 1e6
deserts_gr$width <- width(deserts_gr) / 1e6
deserts2_gr$width <- width(deserts2_gr) / 1e6
```

```{r}
ss_deserts_gr
ss2_deserts_gr
ibdmix_deserts_gr
deserts_gr
deserts2_gr
```

```{r}
deserts_gr <- deserts2_gr
desert_coords <- deserts_gr %>% as.data.frame() %>% select(chrom = seqnames, start, end)
desert_coords
```


## Load and inspect GeoGenetics metadata

```{r}
metadata <- read_metadata()
```

```{r}
glimpse(metadata)
```

Plot the spatial distribution of all ancient samples in the imputed data:

```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")
sf::st_agr(world) <- "constant"
bbox <- st_as_sfc(st_bbox(c(xmin = -25, xmax = 65, ymin = 25, ymax = 70), crs = st_crs(world)))
western_eurasia <- st_crop(st_make_valid(world), bbox)

metadata %>%
  filter(!is.na(latitude) & !is.na(longitude)) %>%
  st_as_sf(coords = c("longitude", "latitude")) %>%
  st_set_crs(4326) %>%
  ggplot() +
    geom_sf(data = western_eurasia) +
    geom_sf(aes(color = region)) +
    coord_sf(crs = 3035)
```

Out of the various "age" columns in the GeoGenetics metadata, which one is actually usable?

```{r}
filter(metadata, groupAge == "Ancient") %>%
  summarise_at(c("age14C", "ageAverage", "ageRaw"),
               list(total = ~length(.), missing = ~sum(is.na(.x)), prop = ~mean(is.na(.x)))) %>%
  pivot_longer(cols = everything(), names_to = "name") %>%
  separate(name, into = c("measure", "type"), sep = "_", extra = "merge")
```

Looks like `ageAverage` has a value for every individual:

```{r}
metadata %>%
  filter(groupAge == "Ancient") %>%
  ggplot() +
  geom_histogram(aes(ageAverage))
```

## Inspect Neanderthal tracts in ancient and present-day individuals

```{r}
tracts_modern <- read_tracts("Modern", metadata)
tracts_ancient <- read_tracts("Ancient", metadata)

tracts <- rbind(tracts_modern, tracts_ancient)

tracts
```

```{r}
tracts %>%
filter(chrom %in% as.character(seqnames(deserts_gr))) %>%
ggplot(aes(x = start, xend = end, y = ID, yend = ID)) +
  geom_segment(linewidth = 1) +
  geom_rect(data = desert_coords, aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf), inherit.aes = FALSE, fill = "red", alpha = 0.1) +
  geom_vline(data = desert_coords, aes(xintercept = start), linetype = "dashed", color = "red") +
  geom_vline(data = desert_coords, aes(xintercept = end), linetype = "dashed", color = "red") +
  labs(x = "position along a chromosome [bp]", y = "each row = tracts in an individual") +
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_blank(),
    panel.grid = element_blank()
  ) +
  scale_x_continuous(labels = scales::comma) +
  facet_grid(set ~ chrom, scales = "free") +
  ggtitle("Neanderthal tracts in Eurasians")
```

```{r}
ggplot2::ggsave(paste0("results/tracts.pdf"), width = 13, height = 7)
```

## Analysis of tracts inferred in real data

Convert the IBDmix tracts data frame to `GRanges`:

```{r}
library(BSgenome.Hsapiens.UCSC.hg19)

tracts_gr <- tracts %>% makeGRangesFromDataFrame(keep.extra.columns = TRUE)

seqlengths(tracts_gr) <- seqlengths(BSgenome.Hsapiens.UCSC.hg19)[names(seqlengths(tracts_gr))]
genome(tracts_gr) <- "hg19"

tracts_gr
```

### Fetch gaps from USCS

```{r}
library(ggbio)
library(rtracklayer)
library(plyranges)

mySession <- browserSession()
genome(mySession) <- "hg19"
query <- ucscTableQuery(mySession, table = "gap")

# gap table columns: https://genome.ucsc.edu/cgi-bin/hgTables?db=hg38&hgta_group=map&hgta_track=gap&hgta_table=gap&hgta_doSchema=describe+table+schema
gaps <- getTable(query) %>%
  dplyr::filter(grepl("chr\\d+$", chrom)) %>% as_tibble()

gaps_gr <- makeGRangesFromDataFrame(gaps, starts.in.df.are.0based = TRUE, keep.extra.columns = TRUE, ignore.strand = TRUE)
seqinfo(gaps_gr) <- seqinfo(tracts_gr)

gaps_gr
```

```{r}
gaps_gr %>%
  filter(seqnames %in% seqnames(deserts_gr)) %>%
  autoplot(aes(fill = type), color = NA) +
  theme_bw() +
  theme(panel.grid = element_blank(), legend.position = "bottom")
```

### Analyse tracts in windows

```{r}
windows_gr <- generate_windows(gaps_gr, window_size = 200e3, step_size = 50e3)
# windows_gr <- filter(windows_gr, seqnames == "chr7")

# mark windows falling within archaic deserts
windows_gr$within_desert <- FALSE
windows_gr[queryHits(findOverlaps(windows_gr, deserts_gr))]$within_desert <- TRUE

ancestry_modern_gr <- filter(tracts_gr, set == "Modern") %>% compute_ancestry(windows_gr)
ancestry_ancient_gr <- filter(tracts_gr, set == "Ancient") %>% compute_ancestry(windows_gr)

ancestry_gr <- granges(windows_gr)
mcols(ancestry_gr) <- cbind(
  mcols(windows_gr),
  mcols(ancestry_ancient_gr)["coverage"] %>% setNames("ancient"),
  mcols(ancestry_modern_gr)["coverage"] %>% setNames("modern") 
)
mcols(ancestry_gr)$within_desert <-
  start(ancestry_gr) >= start(filter(deserts_gr, seqnames == chrom)) &
  end(ancestry_gr) <= end(filter(deserts_gr, seqnames == chrom))
```

```{r}
p1 <- plot_ancestry(ancestry_gr, deserts_gr)
```

```{r}
mean(filter(ancestry_gr, within_desert)$ancient)
mean(filter(ancestry_gr, within_desert)$modern)
```

```{r}
mean(filter(ancestry_gr, !within_desert)$ancient)
mean(filter(ancestry_gr, !within_desert)$modern)
```

```{r}
p2 <- plot_correlation(ancestry_gr)
```

```{r}
cowplot::plot_grid(p1, p2, nrow = 1, rel_widths = c(1, 0.7))
```

```{r}
ggsave(filename = "results/desert_comparison.pdf", width = 13, height = 7, units = "in")
```

```{r}
ancestry_gr %>%
  as_tibble() %>%
  filter(within_desert) %>%
  summarise(
    mean(ancient == 0 & modern > 0),
    mean(ancient > 0 & modern == 0),
    mean((ancient == 0 & modern == 0) | (ancient > 0 & modern > 0))
  ) %>%
  pivot_longer(cols = everything(), values_to = "proportion of sites")
```

```{r}
ancestry_gr %>% filter(within_desert) %>% filter(modern == 0) %>% { .$ancient * 100 } %>% summary()
```
